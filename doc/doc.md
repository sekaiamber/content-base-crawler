# 基于DOM结构相似性的一类爬虫实现

## 0x00 概述

新年新气象，咱也有惊无险再就业成功，最近自己开始研究一些歪门邪道，想来最近部门对抗战场的同学们十分活跃，突然想实现一下自己之前的想法。（其实这个小程序十分简单，只实现了基本原理，而且最近1月新番十分良心，故花了不少时间在补番上）

废话少说，实际上是这样的。现在许多网站真的是机关算尽，对抗战场处处都是勾心斗角，变个`class`之类的小手段不说了，3天一改版，5天一大改版，让做爬取规则的小伙伴操碎了心。

大致上市面上这么几类爬虫产品：

* 传统的传统，规则爬取，根据DOM精确定位，抓取内容
* 标记爬取，大概就是傻瓜式的打开一个页面，点点这儿要爬，然后就自己去爬
* 新秀，根据一些**现阶段**不太靠谱的方式来爬取，像什么机器视觉之类的

我是一贯秉持**新的总是好的**的思想的，上述第三种方式即使现在看起来像是天方夜谭，但是随着技术发展，它们总会替代老的方法，毕竟连围棋都被AI攻陷了。

上面第一种方式，爬取的准确性和目的性十分高，但是制定规则十分依赖专业水平，并且无法抵抗DOM结构变动，不够傻瓜。第二种方式够傻瓜了，市面上类似八爪之类的软件就是这样，但是手动标记十分费时费力，并且也无法抵抗DOM结构变动。这两种方法在目标网站改版之后均需要重新处理规则，不符合程序员一贯的为了解决1分钟的事情花1小时去写个自动化程序的思路。

作为一个轮子爱好者，也是一个尽职尽责的前端工程师，深知网站开发的很多套路，所以总结出一套自以为十分屌的思路，就是下面要介绍的这种页面分析实现，它对DOM结构变动有十分强大的抵抗性，几乎堪称无敌，**但是她只适用于一部分页面的分析爬取，并且无法抵抗某些防守措施**，下面我会详细介绍一下这个分析方案的实现。

请诸位回想一下咱们最常上的网站中，许多页面都有**列表**存在，比如我经常上的[煎蛋](http://jandan.net)这类新闻类网站，也有类似[B站](http://www.bilibili.com/video/bangumi-two-1.html)这样的视频网站，也有像[本厂](https://s.taobao.com/search?q=%E8%B5%A4%E5%BA%A7%E7%81%AF%E9%87%8C&imgfile=&commend=all&ssid=s5-e&search_type=item&sourceId=tb.index&spm=a21bo.50862.201856-taobao-item.1&ie=utf8&initiative_id=tbindexz_20170108)这样的购物网站，这类网站高价值的内容存在下列特征：

* 一个页面存在多条重复结构的内容，一般少则七八条，多则几十条，这些内容价值十分高，是我们的目标。
* 根据现有前端开发技术和动态网页生成的机制，我们知道这些重复内容一般拥有同一个父节点。
* 这些内容每一块一般对应同一个DOM结构，不会说同一块内容分散在不同的DOM中。

基于上述特征，我们很容易想到，我们能否通过寻找这类重复DOM结构，来确定这部分内容，从而摆脱规则的束缚，而从DOM模式来入手，理论上只要页面表达的内容不变，不管页面结构如何变化，这类分析始终有效。

## 0x01 一些前提

很久很久以前，大概在AngularJS还未出现之前，当时后端模板当道，我们可以通过`curl`之类的工具直接获得网页HTML大部分内容（当时虽然也有JS插件这一说，DOM结构会在`DOMready`之后变化，但是有效的信息大部分是写在HTML代码中的，变动也只是在这些基础的HTML上动动手脚）。时过境迁，现在的前端技术比当年不知道高到哪里去了，出来了各种前端模板引擎，像`AngularJS`、`Vue`或者像`React`之类的妖孽，直接`curl`根本取不到想要的内容，故我们需要一个完整的浏览器实现来运行这些JS代码，才能获取需要的真实HTML代码。

市面上用于JS测试的浏览器实现有很多：

* PhantomJS，自己包装的一个黑盒浏览器，能跑JS能各种跳转，就是一个真实的浏览器环境
* 各类WebDriver，比如Chrome浏览器提供的[Chrome Driver](https://sites.google.com/a/chromium.org/chromedriver/downloads)，能使外部程序接入浏览器中，直接操作浏览器。
* JSDom，咱最喜欢的JS测试工具，纯JS实现的**模拟浏览器**，美中不足的是毕竟不是真实浏览器，很多行为跟真实有偏差。

本人也算是前端老司机了，纵然没爬过秋名山，也颇为熟悉西方那一套，还未开始写代码，都想好了各种开发选型的利弊，本例中为图方便使用`Python`开发，若是需要产品化，**强烈建议使用JS开发**。

## 0x05 参考

* [Wiki edit distance](https://en.wikipedia.org/wiki/Edit_distance)
* [Dynamic Programming - edit distance](http://www.geeksforgeeks.org/dynamic-programming-set-5-edit-distance/)
